<!DOCTYPE HTML>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<% if @baseurl %><base href="<%= @baseurl %>" /> <% end %>
  <title><%= @title %></title>

  <% if @favicon %>
    <link rel="icon" href="<%= @favicon %>"/>
  <% end %>

  <% if @inline %>
    <%= inline_css(['font-awesome-5.6.1/css/all.min.css', "highlight/#{@highlightStyle}.css"], 'public/css') %>
    <%= inline_css(['showoff.css', 'onepage.css'], 'public/css') %>
    <%= inline_css(css_files) %>

    <%= inline_js(['jquery-3.7.1.min.js', 'showoff.js', 'highlight.pack-11.11.1.js', 'highlightjs-line-numbers.min.js'], 'public/js') %>
    <%= inline_js(['bigtext-0.1.8.js', 'simpleStrings-0.0.1.js', 'mermaid-11.12.2.min.js'], 'public/js') %>

    <%= inline_js(js_files) %>

  <% else %>
    <% ['font-awesome-5.6.1/css/all.min.css', "highlight/#{@highlightStyle}.css",
        'showoff.css', 'onepage.css'].each do |css_file| %>
      <link rel="stylesheet" href="css/<%= css_file %>" type="text/css"/>
    <% end %>

    <% css_files.each do |css_file| %>
      <link rel="stylesheet" href="<%= css_file %>" type="text/css"/>
    <% end %>

    <% ['jquery-3.7.1.min.js', 'showoff.js', 'highlight.pack-11.11.1.js',
        'highlightjs-line-numbers.min.js', 'bigtext-0.1.8.js', 'simpleStrings-0.0.1.js', 'mermaid-11.12.2.min.js'].each do |js_file| %>
      <script type="text/javascript" src="js/<%= js_file %>"></script>
    <% end %>
    <% js_files.each do |js_file| %>
      <script type="text/javascript" src="<%= js_file %>"></script>
    <% end %>

  <% end %>

  <script type="text/javascript">
    // Initialize mermaid before document ready
    console.log('[MERMAID DEBUG] Initializing mermaid library');
    // Configure mermaid for print - limit diagram width to fit on page
    mermaid.initialize({
      startOnLoad: false,
      maxTextSize: 50000,
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true
      },
      sequence: {
        useMaxWidth: true
      },
      gantt: {
        useMaxWidth: true
      },
      pie: {
        useMaxWidth: true
      }
    });

    $(document).ready(function() {
      console.log('[MERMAID DEBUG] Document ready fired');
      console.log('[MERMAID DEBUG] code.language-render-diagram count:', $('code.language-render-diagram').length);

      $('pre.highlight code').each(function(i, block) {
        // Skip syntax highlighting for mermaid diagrams - they need special handling
        if ($(block).hasClass('language-render-diagram')) {
          console.log('[MERMAID DEBUG] Skipping syntax highlighting for mermaid diagram');
          return;
        }

        try {
          // syntax highlight the code
          hljs.highlightElement(block);

          // then add focus on any lines marked
          highlightLines(block);
        } catch(e) {
          console.log('Syntax highlighting failed on ' + $(this).closest('div.slide').attr('id'));
          console.log('Syntax highlighting failed for ' + $(this).attr('class'));
          console.log(e);
        }
      });

      console.log('[MERMAID DEBUG] After syntax highlighting, code.language-render-diagram count:', $('code.language-render-diagram').length);

      // render diagrams and text manipulations unconditionally instead of waiting for slide views
      // Mermaid needs the code in a div, not in <pre><code>, so transform the DOM first
      $('code.language-render-diagram').each(function() {
        console.log('[MERMAID DEBUG] Transforming code element to div');
        var code = $(this).text();
        console.log('[MERMAID DEBUG] Code content length:', code.length);
        var div = $('<div class="mermaid">').text(code);
        $(this).parent().replaceWith(div);
      });
      console.log('[MERMAID DEBUG] After transformation, div.mermaid count:', $('div.mermaid').length);
      // Use mermaid.run() (v10+) instead of deprecated mermaid.init()
      mermaid.run({
        nodes: document.querySelectorAll('div.mermaid'),
        suppressErrors: false
      }).then(function() {
        console.log('[MERMAID DEBUG] mermaid.run() completed');
        // Fix mermaid SVG scaling for print - force diagrams to fit container width
        var containerWidth = document.querySelector('.slide .content')?.offsetWidth || 960;
        document.querySelectorAll('div.mermaid svg').forEach(function(svg) {
          // Get original viewBox dimensions
          var viewBox = svg.getAttribute('viewBox');
          if (viewBox) {
            var parts = viewBox.split(' ').map(parseFloat);
            var vbWidth = parts[2];
            var vbHeight = parts[3];

            // If diagram is wider than container, we need to scale
            if (vbWidth > containerWidth) {
              console.log('[MERMAID DEBUG] Scaling SVG', svg.id, 'from', vbWidth, 'to fit', containerWidth);
            }
          }

          // Force the SVG to fill container width and scale proportionally
          svg.style.maxWidth = '100%';
          svg.style.width = '100%';
          svg.style.height = 'auto';
          svg.removeAttribute('height'); // Remove fixed height if present

          console.log('[MERMAID DEBUG] Fixed SVG scaling for:', svg.id);
        });
      }).catch(function(err) {
        console.error('[MERMAID DEBUG] mermaid.run() error:', err);
      });
      $('.content.bigtext').bigtext();

      // translate SVG images, inlining them first if needed.
      user_translations = <%= JSON.pretty_generate user_translations %>;
      $('img').simpleStrings({strings: user_translations});
      $('svg').simpleStrings({strings: user_translations});
      $('.translate').simpleStrings({strings: user_translations});
    });
  </script>

</head>

<body class="onepage">
<div id="slides"<% if @wrapper_classes then %>class="<%= @wrapper_classes.join(' ') %>"<% end %> >
  <%= @slides %>
</div>
</body>
</html>
