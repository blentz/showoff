<!DOCTYPE HTML>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<% if @baseurl %><base href="<%= @baseurl %>" /> <% end %>
  <title><%= @title %></title>

  <% if @favicon %>
    <link rel="icon" href="<%= @favicon %>"/>
  <% end %>

  <% if @inline %>
    <%= inline_css(['font-awesome-5.6.1/css/all.min.css', "highlight/#{@highlightStyle}.css"], 'public/css') %>
    <%= inline_css(['showoff.css', 'onepage.css'], 'public/css') %>
    <%= inline_css(css_files) %>

    <%= inline_js(['jquery-3.7.1.min.js', 'showoff.js', 'highlight.pack-11.11.1.js', 'highlightjs-line-numbers.min.js'], 'public/js') %>
    <%= inline_js(['bigtext-0.1.8.js', 'simpleStrings-0.0.1.js', 'mermaid-11.12.2.min.js'], 'public/js') %>

    <%= inline_js(js_files) %>

  <% else %>
    <% ['font-awesome-5.6.1/css/all.min.css', "highlight/#{@highlightStyle}.css",
        'showoff.css', 'onepage.css'].each do |css_file| %>
      <link rel="stylesheet" href="css/<%= css_file %>" type="text/css"/>
    <% end %>

    <% css_files.each do |css_file| %>
      <link rel="stylesheet" href="<%= css_file %>" type="text/css"/>
    <% end %>

    <% ['jquery-3.7.1.min.js', 'showoff.js', 'highlight.pack-11.11.1.js',
        'highlightjs-line-numbers.min.js', 'bigtext-0.1.8.js', 'simpleStrings-0.0.1.js', 'mermaid-11.12.2.min.js', 'mermaid-config.js'].each do |js_file| %>
      <script type="text/javascript" src="js/<%= js_file %>"></script>
    <% end %>
    <% js_files.each do |js_file| %>
      <script type="text/javascript" src="<%= js_file %>"></script>
    <% end %>

  <% end %>

  <script type="text/javascript">
    // Mermaid initialization is now handled in showoff.js for both presentation and print modes
    $(document).ready(function() {
      console.log('[MERMAID DEBUG] Document ready fired');
      console.log('[MERMAID DEBUG] code.language-render-diagram count:', $('code.language-render-diagram').length);

      $('pre.highlight code').each(function(i, block) {
        // Skip syntax highlighting for mermaid diagrams - they need special handling
        if ($(block).hasClass('language-render-diagram')) {
          console.log('[MERMAID DEBUG] Skipping syntax highlighting for mermaid diagram');
          return;
        }

        try {
          // syntax highlight the code
          hljs.highlightElement(block);

          // then add focus on any lines marked
          highlightLines(block);
        } catch(e) {
          console.log('Syntax highlighting failed on ' + $(this).closest('div.slide').attr('id'));
          console.log('Syntax highlighting failed for ' + $(this).attr('class'));
          console.log(e);
        }
      });

      console.log('[MERMAID DEBUG] After syntax highlighting, code.language-render-diagram count:', $('code.language-render-diagram').length);

      // render diagrams and text manipulations unconditionally instead of waiting for slide views
      // Mermaid needs the code in a div, not in <pre><code>, so transform the DOM first
      $('code.language-render-diagram').each(function() {
        console.log('[MERMAID DEBUG] Transforming code element to div');
        var code = $(this).text();
        console.log('[MERMAID DEBUG] Code content length:', code.length);
        var div = $('<div class="mermaid">').text(code);
        $(this).parent().replaceWith(div);
      });
      console.log('[MERMAID DEBUG] After transformation, div.mermaid count:', $('div.mermaid').length);
      // Use mermaid.run() (v10+) instead of deprecated mermaid.init()
      mermaid.run({
        nodes: document.querySelectorAll('div.mermaid'),
        suppressErrors: false
      }).then(function() {
        console.log('[MERMAID DEBUG] mermaid.run() completed');

        // Detect print mode from #slides classes
        var slidesEl = document.getElementById('slides');
        var isPrintNotes = slidesEl && slidesEl.classList.contains('print-notes');
        var isPrintMode = slidesEl && slidesEl.classList.contains('print-mode');

        console.log('[MERMAID DEBUG] Print mode detection - isPrintMode:', isPrintMode, 'isPrintNotes:', isPrintNotes);

        // Letter landscape: 11in x 8.5in, minus 0.5in margins = 10in x 7.5in content area
        // At 72 DPI: 720px width x 540px height available
        // Different strategies for different print modes:

        if (isPrintNotes) {
          // NOTES MODE: Use CSS-based sizing instead of transform scaling
          // Allows browser pagination to work naturally without negative margin confusion
          // Max dimensions: Very conservative sizing to leave room for headers, padding, and page breaks
          var maxWidth = 620;  // ~8.6in at 72 DPI
          var maxHeight = 350; // ~4.9in at 72 DPI - leaves ~2.5in for headers and margins

          console.log('[MERMAID DEBUG] Using print-notes mode scaling (CSS-based)');

          document.querySelectorAll('div.mermaid').forEach(function(container) {
            var svg = container.querySelector('svg');
            if (!svg) return;

            var viewBox = svg.getAttribute('viewBox');
            if (!viewBox) {
              console.log('[MERMAID DEBUG] No viewBox for', svg.id);
              return;
            }

            var parts = viewBox.split(' ').map(parseFloat);
            var vbWidth = parts[2];
            var vbHeight = parts[3];

            // Calculate scale needed to fit constraints
            var scaleWidth = vbWidth > maxWidth ? maxWidth / vbWidth : 1;
            var scaleHeight = vbHeight > maxHeight ? maxHeight / vbHeight : 1;
            var scale = Math.min(scaleWidth, scaleHeight);

            if (scale < 1) {
              // Use CSS width/height constraints instead of transform
              // This lets the browser's pagination engine see the actual rendered size
              var scaledWidth = vbWidth * scale;
              var scaledHeight = vbHeight * scale;

              console.log('[MERMAID DEBUG] CSS-scaling diagram', svg.id, ':', vbWidth + 'x' + vbHeight,
                          '-> ' + scaledWidth.toFixed(0) + 'x' + scaledHeight.toFixed(0),
                          '(scale: ' + scale.toFixed(3) + ')');

              // CRITICAL: Set both CSS dimensions AND SVG attributes
              // PDF renderer respects SVG width/height attributes more than CSS
              svg.setAttribute('width', scaledWidth + 'px');
              svg.setAttribute('height', scaledHeight + 'px');
              svg.style.width = scaledWidth + 'px';
              svg.style.height = scaledHeight + 'px';
              svg.style.maxWidth = 'none';
              svg.style.maxHeight = 'none';

              // Container should match SVG size
              container.style.width = scaledWidth + 'px';
              container.style.height = scaledHeight + 'px';
              container.style.transform = 'none'; // No transform needed
            } else {
              // Diagram fits naturally
              svg.setAttribute('width', vbWidth + 'px');
              svg.setAttribute('height', vbHeight + 'px');
              svg.style.width = vbWidth + 'px';
              svg.style.height = vbHeight + 'px';
              container.style.width = vbWidth + 'px';
              container.style.height = vbHeight + 'px';
              console.log('[MERMAID DEBUG] Diagram', svg.id, 'fits at', vbWidth + 'x' + vbHeight);
            }
          });

        } else {
          // SLIDES-ONLY MODE: Use transform scaling approach
          // Works fine for strict one-slide-per-page layout
          var maxWidth = 680;  // Leave room for padding (720 - 40)
          var maxHeight = 480; // Leave room for padding (540 - 60)

          console.log('[MERMAID DEBUG] Using slides-only mode scaling (transform-based)');

          document.querySelectorAll('div.mermaid').forEach(function(container) {
            var svg = container.querySelector('svg');
            if (!svg) return;

            var viewBox = svg.getAttribute('viewBox');
            if (!viewBox) {
              console.log('[MERMAID DEBUG] No viewBox for', svg.id);
              return;
            }

            var parts = viewBox.split(' ').map(parseFloat);
            var vbWidth = parts[2];
            var vbHeight = parts[3];

            // Calculate scale needed to fit both width AND height constraints
            var scaleWidth = vbWidth > maxWidth ? maxWidth / vbWidth : 1;
            var scaleHeight = vbHeight > maxHeight ? maxHeight / vbHeight : 1;
            var scale = Math.min(scaleWidth, scaleHeight); // Use most restrictive scale

            if (scale < 1) {
              // Diagram needs scaling
              var scaledWidth = vbWidth * scale;
              var scaledHeight = vbHeight * scale;

              console.log('[MERMAID DEBUG] Transform-scaling diagram', svg.id, ':', vbWidth + 'x' + vbHeight,
                          '-> ' + scaledWidth.toFixed(0) + 'x' + scaledHeight.toFixed(0),
                          '(scale: ' + scale.toFixed(3) + ')');

              // Set the SVG to render at its natural size
              svg.style.width = vbWidth + 'px';
              svg.style.height = vbHeight + 'px';
              svg.style.maxWidth = 'none';
              svg.style.maxHeight = 'none';

              // Scale the container down to fit
              container.style.transform = 'scale(' + scale + ')';
              container.style.transformOrigin = 'top left';
              // Set container to natural size (transform will scale it down)
              container.style.width = vbWidth + 'px';
              container.style.height = vbHeight + 'px';
              // Add negative margin to collapse the extra space created by transform
              container.style.marginRight = '-' + (vbWidth - scaledWidth) + 'px';
              container.style.marginBottom = '-' + (vbHeight - scaledHeight) + 'px';
            } else {
              // Diagram fits, just ensure it's properly sized
              svg.style.width = '100%';
              svg.style.height = 'auto';
              svg.style.maxWidth = '100%';
              console.log('[MERMAID DEBUG] Diagram', svg.id, 'fits at', vbWidth + 'x' + vbHeight);
            }
          });
        }
      }).catch(function(err) {
        console.error('[MERMAID DEBUG] mermaid.run() error:', err);
      }).finally(function() {
        // Mark page as ready for printing after mermaid rendering completes
        console.log('[MERMAID DEBUG] Rendering complete, marking page ready for print');
        document.body.classList.add('mermaid-ready');

        // Dispatch custom event for automated tools
        window.dispatchEvent(new Event('mermaid-ready'));
      });

      $('.content.bigtext').bigtext();

      // translate SVG images, inlining them first if needed.
      user_translations = <%= JSON.pretty_generate user_translations %>;
      $('img').simpleStrings({strings: user_translations});
      $('svg').simpleStrings({strings: user_translations});
      $('.translate').simpleStrings({strings: user_translations});
    });
  </script>

  <style type="text/css">
    /* Hide raw mermaid code until JavaScript transforms it
       This prevents printing raw code blocks */
    body:not(.mermaid-ready) code.language-render-diagram {
      visibility: hidden;
      position: relative;
    }

    /* Show loading indicator while mermaid renders */
    body:not(.mermaid-ready) code.language-render-diagram::after {
      content: "⏳ Rendering diagram...";
      visibility: visible;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      color: #666;
      font-style: italic;
      padding: 1em;
      background: #f0f0f0;
    }

    /* Ensure mermaid diagrams are visible after rendering */
    body.mermaid-ready div.mermaid {
      display: block !important;
      visibility: visible !important;
    }

    /* Show prominent message if JavaScript fails to run */
    body:not(.mermaid-ready)::before {
      content: "⚠️ Waiting for diagrams to render... If this message persists, JavaScript may be disabled.";
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff3cd;
      color: #856404;
      padding: 1em;
      text-align: center;
      font-weight: bold;
      border-bottom: 2px solid #ffc107;
      z-index: 9999;
    }

    /* Hide warning once ready */
    body.mermaid-ready::before {
      display: none;
    }
  </style>

</head>

<body class="onepage">
<div id="slides"<% if @wrapper_classes then %>class="<%= @wrapper_classes.join(' ') %>"<% end %> >
  <%= @slides %>
</div>
</body>
</html>
